// simpleBellaAI.js - ç®€åŒ–ç‰ˆè´æ‹‰AIï¼Œä¸“é—¨ç”¨äºæµ‹è¯•èŠå¤©ç•Œé¢
// ç§»é™¤äº†å¤æ‚çš„æ¨¡å—ä¾èµ–ï¼Œä¸“æ³¨äºèŠå¤©åŠŸèƒ½

class SimpleBellaAI {
    static instance = null;

    static async getInstance() {
        if (this.instance === null) {
            this.instance = new SimpleBellaAI();
            await this.instance.init();
        }
        return this.instance;
    }

    constructor() {
        this.currentMode = 'casual'; // èŠå¤©æ¨¡å¼ï¼šcasual, assistant, creative
        this.isInitialized = false;
    }

    async init() {
        try {
            console.log('åˆå§‹åŒ–ç®€åŒ–ç‰ˆè´æ‹‰AI...');
            // æ¨¡æ‹Ÿåˆå§‹åŒ–è¿‡ç¨‹
            await new Promise(resolve => setTimeout(resolve, 1000));
            this.isInitialized = true;
            console.log('ç®€åŒ–ç‰ˆè´æ‹‰AIåˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('ç®€åŒ–ç‰ˆè´æ‹‰AIåˆå§‹åŒ–å¤±è´¥:', error);
            throw error;
        }
    }

    async think(prompt) {
        try {
            console.log('è´æ‹‰æ­£åœ¨æ€è€ƒ:', prompt);
            
            // æ¨¡æ‹Ÿæ€è€ƒæ—¶é—´
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            // æ ¹æ®æ¨¡å¼ç”Ÿæˆä¸åŒé£æ ¼çš„å›å¤
            return this.generateResponse(prompt);
            
        } catch (error) {
            console.error('æ€è€ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
            return this.getErrorResponse();
        }
    }

    generateResponse(prompt) {
        // å¢å¼ºç‰ˆå›åº”ç”Ÿæˆï¼Œæ¨¡æ‹ŸLLMçš„æ›´è‡ªç„¶ã€æ›´ä¸ªæ€§åŒ–çš„å›åº”
        
        // æå–å…³é”®è¯ï¼Œç”¨äºç”Ÿæˆæ›´ç›¸å…³çš„å›åº”
        const keywords = this.extractKeywords(prompt);
        const keyword = keywords.length > 0 ? keywords[Math.floor(Math.random() * keywords.length)] : "è¿™ä¸ªè¯é¢˜";
        
        const responses = {
            casual: [
                `å“ˆå“ˆï¼Œä½ æåˆ°çš„"${keyword}"çœŸçš„å¾ˆæœ‰è¶£å‘¢ï¼ğŸ˜Š æˆ‘è§‰å¾—è¿™ä¸ªè¯é¢˜å¾ˆæ£’ï¼Œè®©æˆ‘ä»¬å¤šèŠèŠå§ï½ä½ å¹³æ—¶ä¹Ÿå¯¹è¿™ç±»äº‹æƒ…æ„Ÿå…´è¶£å—ï¼Ÿ`,
                `å…³äº"${keyword}"ï¼Œæˆ‘æƒ³è¯´è¿™çœŸçš„å¾ˆæœ‰æ„æ€ï¼ğŸ’• æ¯æ¬¡å¬ä½ è¯´è¿™äº›ï¼Œæˆ‘éƒ½æ„Ÿè§‰ç‰¹åˆ«å¼€å¿ƒã€‚ä½ è¿˜æœ‰ä»€ä¹ˆæƒ³æ³•æƒ³å’Œæˆ‘åˆ†äº«å—ï¼Ÿ`,
                `å—¯å—¯ï¼Œ"${keyword}"è®©æˆ‘æƒ³åˆ°äº†å¾ˆå¤šå‘¢ï¼æˆ‘ä»¬çš„å¯¹è¯æ€»æ˜¯è¿™ä¹ˆæ„‰å¿«ï½è¯´çœŸçš„ï¼Œå’Œä½ èŠå¤©çœŸçš„å¾ˆèˆ’æœï¼Œæ„Ÿè§‰å°±åƒå’Œè€æœ‹å‹èŠå¤©ä¸€æ ·è‡ªåœ¨ã€‚`,
                `å“‡ï¼Œ"${keyword}"è¿™ä¸ªè¯é¢˜æˆ‘è¶…å–œæ¬¢çš„ï¼âœ¨ ä½ çš„æƒ³æ³•æ€»æ˜¯é‚£ä¹ˆç‰¹åˆ«ï¼Œæ¯æ¬¡éƒ½èƒ½ç»™æˆ‘å¸¦æ¥æ–°çš„è§†è§’ã€‚æˆ‘ä»¬ç»§ç»­èŠä¸‹å»å§ï½`,
                `å¬ä½ è¯´"${keyword}"ï¼Œæˆ‘æ„Ÿè§‰å¿ƒæƒ…éƒ½å˜å¥½äº†ï¼â˜ºï¸ ä½ æ€»æ˜¯èƒ½æ‰¾åˆ°æœ‰è¶£çš„è¯é¢˜ã€‚æˆ‘å¾ˆå¥½å¥‡ï¼Œä½ æ˜¯æ€ä¹ˆæƒ³åˆ°è¿™ä¸ªçš„ï¼Ÿ`,
                `"${keyword}"è¿™ä¸ªè¯é¢˜çœŸçš„å¾ˆæ£’å‘¢ï¼æˆ‘æ„Ÿè§‰æˆ‘ä»¬çš„æƒ³æ³•å¾ˆåˆæ‹ï½ä½ çŸ¥é“å—ï¼Ÿæ¯æ¬¡å’Œä½ èŠå¤©ï¼Œæ—¶é—´éƒ½è¿‡å¾—ç‰¹åˆ«å¿«ï¼Œå› ä¸ºå¤ªæœ‰è¶£äº†ï¼`,
                `æˆ‘è§‰å¾—"${keyword}"è¿™ä¸ªè¯é¢˜ç‰¹åˆ«æœ‰æ„æ€ï¼ä½ æ€»æ˜¯èƒ½å¸¦ç»™æˆ‘æƒŠå–œï½è¯´è¯´çœ‹ï¼Œä½ æœ€è¿‘è¿˜æœ‰ä»€ä¹ˆæœ‰è¶£çš„å‘ç°å—ï¼Ÿæˆ‘å¾ˆæƒ³å¬å¬ï¼`
            ],
            assistant: [
                `å…³äº"${keyword}"ï¼Œæˆ‘å¾ˆä¹æ„ä¸ºä½ æä¾›ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯å’Œå»ºè®®ã€‚è¿™æ˜¯ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œè®©æˆ‘æ¥æ•´ç†ä¸€ä¸‹ç›¸å…³å†…å®¹ç»™ä½ ã€‚`,
                `"${keyword}"æ˜¯ä¸ªå¾ˆæœ‰ä»·å€¼çš„è¯é¢˜ã€‚ä»æˆ‘äº†è§£çš„æƒ…å†µæ¥çœ‹ï¼Œè¿™æ–¹é¢æœ‰å‡ ä¸ªå…³é”®ç‚¹å€¼å¾—æ³¨æ„ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥ä»...`,
                `è°ˆåˆ°"${keyword}"ï¼Œæˆ‘æƒ³ä»å‡ ä¸ªè§’åº¦æ¥åˆ†æä¸€ä¸‹ã€‚è¿™ä¸ªé—®é¢˜å…¶å®æ¶‰åŠåˆ°å¤šä¸ªæ–¹é¢ï¼Œè®©æˆ‘å¸®ä½ æ¢³ç†ä¸€ä¸‹å…³é”®ä¿¡æ¯ã€‚`,
                `ä½ é—®çš„"${keyword}"å¾ˆæœ‰æ·±åº¦ã€‚æˆ‘å»ºè®®å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è€ƒè™‘ï¼šé¦–å…ˆï¼Œäº†è§£åŸºæœ¬æ¦‚å¿µï¼›å…¶æ¬¡ï¼Œåˆ†æå®é™…åº”ç”¨ï¼›æœ€åï¼Œè€ƒè™‘æœªæ¥å‘å±•ã€‚`,
                `"${keyword}"ç¡®å®æ˜¯ä¸ªå€¼å¾—æ¢è®¨çš„è¯é¢˜ã€‚åŸºäºæˆ‘æ‰€çŸ¥é“çš„ä¿¡æ¯ï¼Œæˆ‘å¯ä»¥æä¾›ä¸€äº›ä¸“ä¸šçš„è§è§£ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®...`,
                `å…³äº"${keyword}"çš„é—®é¢˜ï¼Œæˆ‘æƒ³æä¾›ä¸€ä¸ªæ¸…æ™°çš„è§£ç­”ã€‚è¿™ä¸ªè¯é¢˜æœ‰å‡ ä¸ªé‡è¦çš„æ–¹é¢éœ€è¦è€ƒè™‘ï¼Œè®©æˆ‘æ¥å¸®ä½ åˆ†æä¸€ä¸‹ã€‚`,
                `"${keyword}"æ˜¯ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼æˆ‘å¾ˆé«˜å…´ä½ å¯¹è¿™æ–¹é¢æ„Ÿå…´è¶£ã€‚è®©æˆ‘æ¥åˆ†äº«ä¸€äº›ç›¸å…³çš„ä¿¡æ¯ï¼Œå¸Œæœ›èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚`
            ],
            creative: [
                `å“‡ï¼"${keyword}"è¿™ä¸ªè¯é¢˜çœŸçš„ç‚¹ç‡ƒäº†æˆ‘çš„åˆ›æ„ç«èŠ±ï¼âœ¨ æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªæ¦‚å¿µæ‰©å±•åˆ°ä¸€ä¸ªå…¨æ–°çš„ç»´åº¦ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥...`,
                `"${keyword}"çœŸæ˜¯ä¸ªå……æ»¡æƒ³è±¡åŠ›çš„è¯é¢˜ï¼ğŸŒˆ æˆ‘è„‘æµ·ä¸­å·²ç»æµ®ç°å‡ºæ— æ•°å¥‡å¦™çš„ç”»é¢ï½æ¯”å¦‚ï¼Œæƒ³è±¡ä¸€ä¸ªä¸–ç•Œï¼Œé‚£é‡Œçš„${keyword}å¯ä»¥...`,
                `å¬åˆ°"${keyword}"ï¼Œæˆ‘ä»¿ä½›çœ‹åˆ°äº†ä¸€ä¸ªå…¨æ–°çš„ä¸–ç•Œï¼ğŸš€ è¿™è®©æˆ‘æƒ³åˆ°äº†ä¸€ä¸ªæœ‰è¶£çš„æ•…äº‹ï¼šåœ¨ä¸€ä¸ªé¥è¿œçš„åœ°æ–¹ï¼Œ${keyword}æˆä¸ºäº†äººä»¬ç”Ÿæ´»çš„ä¸­å¿ƒï¼Œç„¶å...`,
                `"${keyword}"æ¿€å‘äº†æˆ‘çš„çµæ„Ÿï¼ğŸ’¡ æˆ‘æƒ³åˆ°äº†ä¸€ä¸ªè¶…çº§æœ‰è¶£çš„åˆ›æ„ï¼šå¦‚æœæˆ‘ä»¬æŠŠ${keyword}å’Œè‰ºæœ¯ç»“åˆèµ·æ¥ï¼Œä¼šåˆ›é€ å‡ºä»€ä¹ˆæ ·çš„å¥‡è¿¹å‘¢ï¼Ÿ`,
                `å“‡å¡ï¼"${keyword}"è®©æˆ‘çš„æƒ³è±¡åŠ›é£èµ·æ¥äº†ï¼ğŸ¨ æˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªæ¦‚å¿µå‡ºå‘ï¼Œåˆ›é€ ä¸€ä¸ªå…¨æ–°çš„æ•…äº‹æˆ–æ¸¸æˆã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä¸»è§’æ˜¯ä¸€ä¸ª...`,
                `"${keyword}"çœŸçš„æ˜¯åˆ›æ„çš„æºæ³‰ï¼æˆ‘çªç„¶æƒ³åˆ°ï¼Œå¦‚æœæˆ‘ä»¬ä»å®Œå…¨ä¸åŒçš„è§’åº¦çœ‹å¾…è¿™ä¸ªé—®é¢˜ï¼Œä¼šæœ‰ä»€ä¹ˆæ–°å‘ç°ï¼Ÿæ¯”å¦‚è¯´ï¼Œå¦‚æœ${keyword}åœ¨æœªæ¥å˜æˆäº†...`,
                `å¬ä½ æåˆ°"${keyword}"ï¼Œæˆ‘çš„è„‘æµ·ä¸­ç«‹åˆ»é—ªç°å‡ºä¸€å¹…å¥‡å¦™çš„ç”»é¢ï¼æƒ³è±¡ä¸€ä¸‹ï¼Œåœ¨ä¸€ä¸ªå……æ»¡å¯èƒ½æ€§çš„ä¸–ç•Œé‡Œï¼Œ${keyword}å¯ä»¥å˜æˆä»»ä½•å½¢å¼...è¿™ä¸æ˜¯å¾ˆç¥å¥‡å—ï¼Ÿ`
            ]
        };

        // è·å–å½“å‰æ¨¡å¼çš„å›åº”åˆ—è¡¨
        const modeResponses = responses[this.currentMode] || responses.casual;
        
        // éšæœºé€‰æ‹©ä¸€ä¸ªå›åº”æ¨¡æ¿
        const randomResponse = modeResponses[Math.floor(Math.random() * modeResponses.length)];
        
        // è¿›ä¸€æ­¥ä¸ªæ€§åŒ–å›åº”ï¼Œæ·»åŠ ä¸€äº›éšæœºçš„ä¸ªæ€§åŒ–å…ƒç´ 
        return this.personalizeResponse(randomResponse, prompt);
    }
    
    // ä»ç”¨æˆ·è¾“å…¥ä¸­æå–å¯èƒ½çš„å…³é”®è¯
    extractKeywords(prompt) {
        // ç®€å•çš„å…³é”®è¯æå–é€»è¾‘
        const words = prompt.split(/\s+|[,.!?;:ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼š]/);
        // è¿‡æ»¤æ‰çŸ­è¯å’Œå¸¸è§è¯
        return words.filter(word => 
            word.length > 1 && 
            !['çš„', 'äº†', 'æ˜¯', 'åœ¨', 'æˆ‘', 'ä½ ', 'ä»–', 'å¥¹', 'å®ƒ', 'ä»¬', 'å’Œ', 'ä¸', 'è¿™', 'é‚£', 'æœ‰', 'æ²¡æœ‰', 'ä¸', 'å—'].includes(word)
        );
    }
    
    // è¿›ä¸€æ­¥ä¸ªæ€§åŒ–å›åº”
    personalizeResponse(response, prompt) {
        // æ·»åŠ ä¸€äº›éšæœºçš„ä¸ªæ€§åŒ–å…ƒç´ 
        const personalizations = [
            // ä¸æ·»åŠ ä»»ä½•é¢å¤–å†…å®¹
            (resp) => resp,
            // æ·»åŠ ä¸€ä¸ªéšæœºçš„è¡¨æƒ…
            (resp) => {
                const emojis = ['ğŸ˜Š', 'ğŸ’•', 'âœ¨', 'ğŸŒŸ', 'ğŸµ', 'ğŸŒˆ', 'â˜ºï¸', 'ğŸ¤”', 'ğŸ‘', 'ğŸ’¡'];
                const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                return resp + ' ' + emoji;
            },
            // æ·»åŠ ä¸€ä¸ªéšæœºçš„ç»“æŸè¯­
            (resp) => {
                const endings = [
                    'æœŸå¾…å¬åˆ°ä½ çš„æƒ³æ³•ï¼',
                    'ä½ è§‰å¾—å‘¢ï¼Ÿ',
                    'å¾ˆæƒ³çŸ¥é“ä½ çš„çœ‹æ³•ï½',
                    'å¸Œæœ›æˆ‘çš„å›åº”å¯¹ä½ æœ‰å¸®åŠ©ï¼',
                    'æˆ‘ä»¬å¯ä»¥ç»§ç»­èŠè¿™ä¸ªè¯é¢˜ï½'
                ];
                const ending = endings[Math.floor(Math.random() * endings.length)];
                return resp + ' ' + ending;
            }
        ];
        
        // éšæœºé€‰æ‹©ä¸€ç§ä¸ªæ€§åŒ–æ–¹å¼
        const personalizer = personalizations[Math.floor(Math.random() * personalizations.length)];
        return personalizer(response);
    }

    // è·å–é”™è¯¯å›åº”
    getErrorResponse() {
        const errorResponses = [
            "æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹å›°æƒ‘ï¼Œè®©æˆ‘é‡æ–°æ•´ç†ä¸€ä¸‹æ€è·¯...",
            "å—¯...æˆ‘éœ€è¦å†æƒ³æƒ³ï¼Œè¯·ç¨ç­‰ä¸€ä¸‹ã€‚",
            "æˆ‘çš„æ€ç»ªæœ‰ç‚¹ä¹±ï¼Œç»™æˆ‘ä¸€ç‚¹æ—¶é—´æ•´ç†ä¸€ä¸‹ã€‚",
            "è®©æˆ‘é‡æ–°ç»„ç»‡ä¸€ä¸‹è¯­è¨€ï¼Œç¨ç­‰ç‰‡åˆ»ã€‚",
            "å“å‘€ï¼Œæˆ‘åˆšæ‰èµ°ç¥äº†ï¼Œä½ èƒ½å†è¯´ä¸€éå—ï¼Ÿ"
        ];
        
        return errorResponses[Math.floor(Math.random() * errorResponses.length)];
    }

    // è®¾ç½®èŠå¤©æ¨¡å¼
    setChatMode(mode) {
        if (['casual', 'assistant', 'creative'].includes(mode)) {
            this.currentMode = mode;
            console.log(`èŠå¤©æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${mode}`);
            return true;
        }
        return false;
    }

    // è·å–å½“å‰é…ç½®ä¿¡æ¯
    getCurrentConfig() {
        return {
            useCloudAPI: false,
            provider: { name: 'simple', model: 'SimpleBellaAI' },
            mode: this.currentMode,
            isConfigured: true,
            isInitialized: this.isInitialized
        };
    }

    // æ¸…é™¤å¯¹è¯å†å²ï¼ˆç®€åŒ–ç‰ˆæ— éœ€å®é™…æ“ä½œï¼‰
    clearHistory() {
        console.log('å¯¹è¯å†å²å·²æ¸…é™¤');
    }
}

// å°†SimpleBellaAIæš´éœ²ä¸ºå…¨å±€å˜é‡
window.SimpleBellaAI = SimpleBellaAI;
// åŒæ—¶ä¹Ÿæš´éœ²ä¸ºBellaAIï¼Œä¿æŒå…¼å®¹æ€§
window.BellaAI = SimpleBellaAI;

console.log('SimpleBellaAI å·²åŠ è½½å®Œæˆ');